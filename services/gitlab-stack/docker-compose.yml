version: '3.8'

# GitLab Stack for Rawls
# Self-hosted Git server and CI/CD platform
#
# Services:
#   - GitLab CE: Git server, CI/CD, container registry
#   - GitLab Runner: CI/CD job executor (optional)

services:
  # ============================================
  # GitLab CE - Self-hosted Git Server
  # ============================================
  gitlab:
    image: gitlab/gitlab-ce:${GITLAB_VERSION:-latest}
    container_name: gitlab
    hostname: ${GITLAB_HOSTNAME:-gitlab.lab.local}
    restart: unless-stopped
    ports:
      - "${GITLAB_HTTP_PORT:-80}:80"
      - "${GITLAB_HTTPS_PORT:-443}:443"
      - "${GITLAB_SSH_PORT:-2222}:22"
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        # External URL - how users access GitLab
        external_url '${GITLAB_EXTERNAL_URL:-http://10.203.3.47}'

        # SSH settings
        gitlab_rails['gitlab_shell_ssh_port'] = ${GITLAB_SSH_PORT:-2222}

        # Disable unnecessary services to reduce memory usage
        prometheus_monitoring['enable'] = false
        grafana['enable'] = false

        # Puma (web server) tuning for homelab
        puma['worker_processes'] = 2
        puma['min_threads'] = 1
        puma['max_threads'] = 4

        # Sidekiq (background jobs) tuning
        sidekiq['max_concurrency'] = 10

        # PostgreSQL tuning
        postgresql['shared_buffers'] = "256MB"

        # Container Registry (optional)
        registry_external_url '${REGISTRY_EXTERNAL_URL:-}'

        # SMTP settings (optional)
        gitlab_rails['smtp_enable'] = ${SMTP_ENABLED:-false}

        # Backup settings
        gitlab_rails['backup_keep_time'] = 604800

        # Time zone
        gitlab_rails['time_zone'] = '${GITLAB_TIMEZONE:-America/Los_Angeles}'
    volumes:
      - gitlab_config:/etc/gitlab
      - gitlab_logs:/var/log/gitlab
      - gitlab_data:/var/opt/gitlab
    shm_size: '256m'
    networks:
      - gitlab-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/-/health"]
      interval: 60s
      timeout: 30s
      retries: 5
      start_period: 300s

  # ============================================
  # GitLab Runner - CI/CD Job Executor
  # ============================================
  gitlab-runner:
    image: gitlab/gitlab-runner:${RUNNER_VERSION:-latest}
    container_name: gitlab-runner
    restart: unless-stopped
    volumes:
      - gitlab_runner_config:/etc/gitlab-runner
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - gitlab-network
    depends_on:
      gitlab:
        condition: service_healthy
    profiles:
      - runner  # Only start with --profile runner

volumes:
  gitlab_config:
  gitlab_logs:
  gitlab_data:
  gitlab_runner_config:

networks:
  gitlab-network:
    driver: bridge
