version: '3.8'

# AI Apps Stack for ai-gpu1
# Light AI-enabled apps that call Ollama remotely
#
# Services:
#   - Karakeep: AI-powered bookmarking
#   - Meilisearch: Search backend
#   - Chrome: Browser automation
#
# NOTE: Calls Ollama on ai-gpu0 via OLLAMA_HOST

services:
  # ============================================
  # Karakeep - AI Bookmarking
  # ============================================
  karakeep:
    image: ghcr.io/karakeep-app/karakeep:${KARAKEEP_VERSION:-release}
    container_name: karakeep
    restart: unless-stopped
    ports:
      - "${KARAKEEP_PORT:-3000}:3000"
    environment:
      - MEILI_ADDR=http://meilisearch:7700
      - BROWSER_WEB_URL=http://chrome:9222
      - DATA_DIR=/data
      # Auth
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - NEXTAUTH_URL=${NEXTAUTH_URL:-http://localhost:3000}
      # Remote Ollama (on ai-gpu0)
      - OLLAMA_BASE_URL=http://${OLLAMA_HOST}:11434
      - INFERENCE_TEXT_MODEL=${INFERENCE_TEXT_MODEL:-llama3.2:3b}
      - INFERENCE_IMAGE_MODEL=${INFERENCE_IMAGE_MODEL:-llava:7b}
      - INFERENCE_CONTEXT_LENGTH=${INFERENCE_CONTEXT_LENGTH:-2048}
      # Optional: Cloud API fallback
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
    volumes:
      - karakeep_data:/data
    networks:
      - ai-network
    depends_on:
      - meilisearch
      - chrome

  # ============================================
  # Meilisearch - Search Backend
  # ============================================
  meilisearch:
    image: getmeili/meilisearch:v1.13.3
    container_name: meilisearch
    restart: unless-stopped
    environment:
      - MEILI_NO_ANALYTICS=true
      - MEILI_MASTER_KEY=${MEILISEARCH_MASTER_KEY}
    volumes:
      - meilisearch_data:/meili_data
    networks:
      - ai-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7700/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Chrome - Browser Automation
  # ============================================
  chrome:
    image: gcr.io/zenika-hub/alpine-chrome:124
    container_name: chrome
    restart: unless-stopped
    command:
      - --no-sandbox
      - --disable-gpu
      - --disable-dev-shm-usage
      - --remote-debugging-address=0.0.0.0
      - --remote-debugging-port=9222
      - --hide-scrollbars
    networks:
      - ai-network

volumes:
  karakeep_data:
  meilisearch_data:

networks:
  ai-network:
    driver: bridge
