#!/usr/bin/env python3
"""
Netbox to Technitium DNS Sync Script

Reads IP addresses from Netbox IPAM and creates corresponding
A records in Technitium DNS server.

Generated by Ansible - do not edit directly.
"""

import sys
import json
import logging
import requests
from datetime import datetime
from typing import Dict, List, Optional, Tuple

# Configuration (templated by Ansible)
NETBOX_URL = "{{ sync_netbox_url }}"
NETBOX_TOKEN = "{{ sync_netbox_token }}"
DNS_URL = "{{ sync_dns_url }}"
DNS_USERNAME = "{{ sync_dns_username }}"
DNS_PASSWORD = "{{ sync_dns_password }}"
DNS_ZONE = "{{ sync_dns_zone }}"
LOG_FILE = "{{ sync_log_file }}"

# Set up logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler(LOG_FILE),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)


class TechnitiumDNS:
    """Client for Technitium DNS Server API"""

    def __init__(self, base_url: str, username: str, password: str):
        self.base_url = base_url.rstrip('/')
        self.username = username
        self.password = password
        self.token = None
        self.session = requests.Session()

    def login(self) -> bool:
        """Authenticate with Technitium DNS server"""
        try:
            response = self.session.get(
                f"{self.base_url}/api/user/login",
                params={
                    "user": self.username,
                    "pass": self.password,
                    "includeInfo": "false"
                }
            )
            data = response.json()
            if data.get("status") == "ok":
                self.token = data.get("token")
                logger.info("Successfully authenticated with DNS server")
                return True
            else:
                logger.error(f"DNS login failed: {data.get('errorMessage', 'Unknown error')}")
                return False
        except Exception as e:
            logger.error(f"DNS login error: {e}")
            return False

    def get_records(self, zone: str, domain: str) -> List[Dict]:
        """Get existing DNS records for a domain"""
        if not self.token:
            return []

        try:
            response = self.session.get(
                f"{self.base_url}/api/zones/records/get",
                params={
                    "token": self.token,
                    "zone": zone,
                    "domain": domain,
                    "listZone": "false"
                }
            )
            data = response.json()
            if data.get("status") == "ok":
                return data.get("response", {}).get("records", [])
            return []
        except Exception as e:
            logger.debug(f"Error getting records for {domain}: {e}")
            return []

    def add_record(self, zone: str, domain: str, record_type: str, value: str, ttl: int = 3600) -> bool:
        """Add a DNS record"""
        if not self.token:
            return False

        try:
            # Check if record already exists
            existing = self.get_records(zone, domain)
            for record in existing:
                if record.get("type") == record_type and record.get("rData", {}).get("ipAddress") == value:
                    logger.debug(f"Record already exists: {domain} -> {value}")
                    return True

            response = self.session.get(
                f"{self.base_url}/api/zones/records/add",
                params={
                    "token": self.token,
                    "zone": zone,
                    "domain": domain,
                    "type": record_type,
                    "ipAddress": value,
                    "ttl": ttl,
                    "overwrite": "true"
                }
            )
            data = response.json()
            if data.get("status") == "ok":
                logger.info(f"Added record: {domain} -> {value}")
                return True
            else:
                logger.error(f"Failed to add record {domain}: {data.get('errorMessage', 'Unknown error')}")
                return False
        except Exception as e:
            logger.error(f"Error adding record {domain}: {e}")
            return False

    def delete_record(self, zone: str, domain: str, record_type: str, value: str) -> bool:
        """Delete a DNS record"""
        if not self.token:
            return False

        try:
            response = self.session.get(
                f"{self.base_url}/api/zones/records/delete",
                params={
                    "token": self.token,
                    "zone": zone,
                    "domain": domain,
                    "type": record_type,
                    "ipAddress": value
                }
            )
            data = response.json()
            if data.get("status") == "ok":
                logger.info(f"Deleted record: {domain} -> {value}")
                return True
            return False
        except Exception as e:
            logger.error(f"Error deleting record {domain}: {e}")
            return False


class NetboxClient:
    """Client for Netbox API"""

    def __init__(self, base_url: str, token: str):
        self.base_url = base_url.rstrip('/')
        self.token = token
        self.headers = {
            "Authorization": f"Token {token}",
            "Content-Type": "application/json",
            "Accept": "application/json"
        }

    def get_ip_addresses(self) -> List[Dict]:
        """Get all IP addresses from Netbox that have DNS names"""
        ip_addresses = []
        url = f"{self.base_url}/api/ipam/ip-addresses/"

        try:
            while url:
                response = requests.get(url, headers=self.headers, timeout=30)
                if response.status_code != 200:
                    logger.error(f"Netbox API error: {response.status_code}")
                    break

                data = response.json()
                for ip in data.get("results", []):
                    # Only include IPs with DNS names
                    dns_name = ip.get("dns_name", "").strip()
                    if dns_name:
                        ip_addresses.append({
                            "address": ip.get("address", "").split("/")[0],  # Remove CIDR
                            "dns_name": dns_name,
                            "status": ip.get("status", {}).get("value", "active"),
                            "description": ip.get("description", "")
                        })

                url = data.get("next")

        except Exception as e:
            logger.error(f"Error fetching IP addresses from Netbox: {e}")

        return ip_addresses


def sync_netbox_to_dns(dns: TechnitiumDNS, netbox: NetboxClient, zone: str) -> Tuple[int, int, int]:
    """
    Sync IP addresses from Netbox to DNS.
    Returns (added, updated, errors) counts.
    """
    added = 0
    updated = 0  # We use overwrite=true, so updates count as adds
    errors = 0

    ip_addresses = netbox.get_ip_addresses()
    logger.info(f"Found {len(ip_addresses)} IP addresses with DNS names in Netbox")

    for ip_entry in ip_addresses:
        dns_name = ip_entry["dns_name"]
        ip_address = ip_entry["address"]

        # Handle FQDN or short name
        if dns_name.endswith(f".{zone}"):
            fqdn = dns_name
        elif dns_name.endswith("."):
            # Already FQDN but different zone - skip
            logger.debug(f"Skipping {dns_name} - different zone")
            continue
        else:
            fqdn = f"{dns_name}.{zone}"

        # Add/update the A record
        if dns.add_record(zone, fqdn, "A", ip_address):
            added += 1
        else:
            errors += 1

    return added, updated, errors


def main():
    """Main entry point"""
    logger.info("=" * 60)
    logger.info(f"Netbox â†’ DNS Sync Started at {datetime.now().isoformat()}")
    logger.info("=" * 60)

    # Validate configuration
    if not NETBOX_TOKEN or NETBOX_TOKEN == "":
        logger.error("NETBOX_TOKEN not configured. Please set vault_netbox_api_token.")
        sys.exit(1)

    # Initialize clients
    dns = TechnitiumDNS(DNS_URL, DNS_USERNAME, DNS_PASSWORD)
    netbox = NetboxClient(NETBOX_URL, NETBOX_TOKEN)

    # Authenticate with DNS server
    if not dns.login():
        logger.error("Failed to authenticate with DNS server")
        sys.exit(1)

    # Perform sync
    try:
        added, updated, errors = sync_netbox_to_dns(dns, netbox, DNS_ZONE)

        logger.info("-" * 40)
        logger.info(f"Sync Complete:")
        logger.info(f"  Records added/updated: {added}")
        logger.info(f"  Errors: {errors}")
        logger.info("-" * 40)

        if errors > 0:
            sys.exit(1)

    except Exception as e:
        logger.error(f"Sync failed with error: {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()
