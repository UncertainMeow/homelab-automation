---
# User Management Role
# Creates admin user (kellen) and ansible automation user

# ============================================
# Admin User (kellen)
# ============================================
- name: Create admin user
  user:
    name: "{{ admin_user }}"
    shell: "{{ admin_shell }}"
    groups: "{{ admin_groups }}"
    append: yes
    create_home: yes
    state: present
  tags: [users, admin]

- name: Set up SSH directory for admin user
  file:
    path: "/home/{{ admin_user }}/.ssh"
    state: directory
    owner: "{{ admin_user }}"
    group: "{{ admin_user }}"
    mode: '0700'
  tags: [users, admin, ssh]

- name: Add SSH authorized keys for admin user
  authorized_key:
    user: "{{ admin_user }}"
    key: "{{ item }}"
    state: present
  loop: "{{ admin_ssh_keys }}"
  tags: [users, admin, ssh]

- name: Allow admin user passwordless sudo
  copy:
    dest: "/etc/sudoers.d/{{ admin_user }}"
    content: "{{ admin_user }} ALL=(ALL) NOPASSWD: ALL\n"
    mode: '0440'
    validate: 'visudo -cf %s'
  tags: [users, admin, sudo]

# ============================================
# Automation User (for ansible/CI)
# ============================================
- name: Create automation user
  user:
    name: "{{ automation_user }}"
    shell: "{{ automation_shell }}"
    groups: "{{ automation_groups }}"
    append: yes
    create_home: yes
    system: yes
    comment: "Automation Account (Ansible/CI)"
    state: present
  tags: [users, automation]

- name: Set up SSH directory for automation user
  file:
    path: "/home/{{ automation_user }}/.ssh"
    state: directory
    owner: "{{ automation_user }}"
    group: "{{ automation_user }}"
    mode: '0700'
  tags: [users, automation, ssh]

- name: Add SSH authorized keys for automation user
  authorized_key:
    user: "{{ automation_user }}"
    key: "{{ item }}"
    state: present
  loop: "{{ automation_ssh_keys }}"
  tags: [users, automation, ssh]

- name: Allow automation user passwordless sudo
  copy:
    dest: "/etc/sudoers.d/{{ automation_user }}"
    content: "{{ automation_user }} ALL=(ALL) NOPASSWD: ALL\n"
    mode: '0440'
    validate: 'visudo -cf %s'
  tags: [users, automation, sudo]

# ============================================
# SSH Hardening (Optional)
# ============================================
- name: Disable password authentication
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PasswordAuthentication'
    line: 'PasswordAuthentication no'
    backup: yes
  when: disable_password_auth | default(true)
  notify: restart sshd
  tags: [users, ssh, security]

- name: Disable root SSH login
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PermitRootLogin'
    line: 'PermitRootLogin no'
    backup: yes
  when: disable_root_ssh | default(false)
  notify: restart sshd
  tags: [users, ssh, security]

# ============================================
# Verification
# ============================================
- name: Verify admin user exists
  command: id {{ admin_user }}
  register: admin_check
  changed_when: false
  tags: [users, verify]

- name: Verify automation user exists
  command: id {{ automation_user }}
  register: automation_check
  changed_when: false
  tags: [users, verify]

- name: Display user setup summary
  debug:
    msg: |
      User Management Complete
      ═══════════════════════════════════════
      Admin User: {{ admin_user }}
        - Groups: {{ admin_groups | join(', ') }}
        - SSH Keys: {{ admin_ssh_keys | length }}
        - Sudo: passwordless

      Automation User: {{ automation_user }}
        - Groups: {{ automation_groups | join(', ') }}
        - SSH Keys: {{ automation_ssh_keys | length }}
        - Sudo: passwordless

      SSH Hardening:
        - Password auth: {{ 'disabled' if disable_password_auth else 'enabled' }}
        - Root login: {{ 'disabled' if disable_root_ssh else 'enabled' }}

      ⚠️  Test SSH as {{ admin_user }} before disabling root!
  tags: [users, verify]
